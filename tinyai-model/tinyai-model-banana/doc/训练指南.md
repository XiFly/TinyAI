# Banana å¤šæ¨¡æ€æ¨¡å‹è®­ç»ƒæŒ‡å—

## ğŸ“š æ¦‚è¿°

Bananaæ˜¯ä¸€ä¸ªåŸºäºVision Transformerçš„å¤šæ¨¡æ€å›¾åƒç”Ÿæˆæ¨¡å‹ï¼Œæ”¯æŒæ–‡æœ¬-å›¾åƒèåˆå’Œé«˜è´¨é‡å›¾åƒç”Ÿæˆã€‚æœ¬æ–‡æ¡£è¯¦ç»†ä»‹ç»å¦‚ä½•ä½¿ç”¨TinyAIæ¡†æ¶è®­ç»ƒBananaæ¨¡å‹ï¼ŒåŒ…æ‹¬é¢„è®­ç»ƒã€å¾®è°ƒå’Œæ¨ç†çš„å®Œæ•´æµç¨‹ã€‚

## ğŸ¯ è®­ç»ƒç›®æ ‡

### é¢„è®­ç»ƒç›®æ ‡
- **å¤šæ¨¡æ€å¯¹æ¯”å­¦ä¹ **: å­¦ä¹ æ–‡æœ¬å’Œå›¾åƒçš„è”åˆè¡¨ç¤º
- **ç‰¹å¾å¯¹é½**: å°†æ–‡æœ¬ç‰¹å¾å’Œå›¾åƒç‰¹å¾æ˜ å°„åˆ°åŒä¸€è¯­ä¹‰ç©ºé—´
- **é‡å»ºä»»åŠ¡**: é€šè¿‡ç‰¹å¾é‡å»ºå­¦ä¹ å¤šæ¨¡æ€èåˆèƒ½åŠ›

### å¾®è°ƒç›®æ ‡
- **ä»»åŠ¡ç‰¹å®šä¼˜åŒ–**: é’ˆå¯¹æ–‡æœ¬ç”Ÿæˆå›¾åƒã€å›¾åƒç¼–è¾‘ç­‰ä¸‹æ¸¸ä»»åŠ¡
- **é£æ ¼è¿ç§»**: å­¦ä¹ ç‰¹å®šé£æ ¼çš„å›¾åƒç”Ÿæˆ
- **è´¨é‡æå‡**: åœ¨ç‰¹å®šé¢†åŸŸæ•°æ®ä¸Šæå‡ç”Ÿæˆè´¨é‡

---

## ğŸ—ï¸ è®­ç»ƒæ¶æ„

### æ•°æ®æµç¨‹

```
æ–‡æœ¬è¾“å…¥ (Text)              å›¾åƒè¾“å…¥ (Image)
     â†“                            â†“
TextEncoder                  ImageEncoder
     â†“                            â†“
æ–‡æœ¬ç‰¹å¾ [B, L, D]          å›¾åƒç‰¹å¾ [B, N, D]
     â†“                            â†“
     â””â”€â”€â”€â”€â”€â”€â”€â”€â†’ è·¨æ¨¡æ€èåˆ â†â”€â”€â”€â”€â”€â”€â”€â”˜
                    â†“
            èåˆç‰¹å¾ [B, N, D]
                    â†“
              é‡å»ºæŸå¤±è®¡ç®—
                    â†“
              æ¢¯åº¦åå‘ä¼ æ’­
```

### è®­ç»ƒç»„ä»¶

| ç»„ä»¶ | åŠŸèƒ½ | å®ç°ç±» |
|------|------|--------|
| **æ•°æ®é›†** | æ–‡æœ¬-å›¾åƒå¯¹æ•°æ®åŠ è½½ | `BananaDataset` |
| **é¢„è®­ç»ƒå™¨** | å¤šæ¨¡æ€é¢„è®­ç»ƒ | `PretrainTrainer` |
| **å¾®è°ƒå™¨** | ä»»åŠ¡ç‰¹å®šå¾®è°ƒ | `FinetuneTrainer` |
| **è®­ç»ƒæ¼”ç¤º** | å®Œæ•´è®­ç»ƒæµç¨‹ç¤ºä¾‹ | `TrainDemo` |

---

## ğŸ“¦ æ•°æ®å‡†å¤‡

### 1. æ•°æ®æ ¼å¼

#### CSVæ ¼å¼ï¼ˆçœŸå®æ•°æ®ï¼‰
```csv
text,image_path
"A photo of a cat",/path/to/images/cat001.jpg
"A beautiful landscape",/path/to/images/landscape002.jpg
"A modern building",/path/to/images/building003.jpg
```

#### åˆæˆæ•°æ®ï¼ˆæ¼”ç¤ºç”¨ï¼‰
```java
BananaDataset dataset = new BananaDataset(
    32,                    // maxTextLen - æœ€å¤§æ–‡æœ¬é•¿åº¦
    256,                   // imageSize - å›¾åƒå°ºå¯¸
    4                      // batchSize - æ‰¹æ¬¡å¤§å°
);
dataset.loadSyntheticData(100);  // ç”Ÿæˆ100ä¸ªåˆæˆæ ·æœ¬
```

### 2. æ•°æ®é›†API

```java
/**
 * ä»CSVæ–‡ä»¶åŠ è½½çœŸå®æ•°æ®
 */
dataset.loadFromCSV("data/train.csv");

/**
 * ç”Ÿæˆåˆæˆæ•°æ®ï¼ˆç”¨äºæµ‹è¯•ï¼‰
 */
dataset.loadSyntheticData(sampleCount);

/**
 * å‡†å¤‡æ‰¹æ¬¡æ•°æ®
 */
dataset.prepare(true);  // shuffle=true æ‰“ä¹±æ•°æ®

/**
 * è¿­ä»£æ‰¹æ¬¡
 */
while (dataset.hasNextBatch()) {
    BananaDataset.Batch batch = dataset.getNextBatch();
    NdArray textInput = batch.getTextInput();   // [batchSize, maxTextLen]
    NdArray imageInput = batch.getImageInput(); // [batchSize, 3, H, W]
}
```

---

## ğŸš€ é¢„è®­ç»ƒæµç¨‹

### è®­ç»ƒé…ç½®

| é…ç½®é¡¹ | Tiny (æ•™å­¦) | Small (å®éªŒ) | Base (æ ‡å‡†) | è¯´æ˜ |
|--------|------------|-------------|------------|------|
| **æ¨¡å‹å‚æ•°** | 60.82M | 166.72M | 385.88M | æ€»å‚æ•°é‡ |
| **å­¦ä¹ ç‡** | 1e-3 | 1e-4 | 5e-5 | åˆå§‹å­¦ä¹ ç‡ |
| **é¢„çƒ­æ­¥æ•°** | 0 | 500 | 1000 | Warmup steps |
| **æ‰¹æ¬¡å¤§å°** | 4 | 8 | 16 | Batch size |
| **è®­ç»ƒè½®æ¬¡** | 2-5 | 10-20 | 50-100 | Epochs |
| **æ¢¯åº¦è£å‰ª** | 1.0 | 1.0 | 1.0 | Max grad norm |

### å®Œæ•´ä»£ç ç¤ºä¾‹

```java
package io.leavesfly.tinyai.banana.training;

import io.leavesfly.tinyai.banana.config.BananaConfig;
import io.leavesfly.tinyai.banana.model.BananaModel;
import io.leavesfly.tinyai.banana.training.dataset.BananaDataset;

public class PretrainExample {
    
    public static void main(String[] args) {
        // 1. åˆ›å»ºæ¨¡å‹ï¼ˆé€‰æ‹©åˆé€‚çš„è§„æ¨¡ï¼‰
        BananaModel model = BananaModel.create("banana_tiny", "tiny");
        System.out.println(model.getConfigSummary());
        
        // 2. å‡†å¤‡è®­ç»ƒæ•°æ®
        BananaConfig config = model.getConfig();
        BananaDataset dataset = new BananaDataset(
            32,                    // maxTextLen
            config.getImageSize(), // imageSize
            4                      // batchSize
        );
        
        // åŠ è½½æ•°æ®ï¼ˆäºŒé€‰ä¸€ï¼‰
        // dataset.loadFromCSV("data/pretrain.csv");     // çœŸå®æ•°æ®
        dataset.loadSyntheticData(1000);                 // åˆæˆæ•°æ®
        
        // 3. åˆ›å»ºé¢„è®­ç»ƒå™¨
        PretrainTrainer trainer = new PretrainTrainer(model, dataset);
        
        // 4. é…ç½®è®­ç»ƒå‚æ•°
        trainer.configure(
            10,        // maxEpochs - è®­ç»ƒè½®æ¬¡
            1e-3f,     // learningRate - å­¦ä¹ ç‡
            0,         // warmupSteps - é¢„çƒ­æ­¥æ•°ï¼ˆTinyæ¨¡å‹å¯ä¸é¢„çƒ­ï¼‰
            1.0f       // maxGradNorm - æ¢¯åº¦è£å‰ªé˜ˆå€¼
        );
        
        // 5. é…ç½®æ£€æŸ¥ç‚¹ä¿å­˜
        trainer.setCheckpoint(
            "./checkpoints/banana_pretrain",  // ä¿å­˜ç›®å½•
            100                                // ä¿å­˜é—´éš”ï¼ˆæ¯100æ­¥ï¼‰
        );
        
        // 6. è®¾ç½®æ—¥å¿—é—´éš”
        trainer.setLogInterval(10);  // æ¯10æ­¥æ‰“å°æ—¥å¿—
        
        // 7. å¼€å§‹è®­ç»ƒ
        System.out.println("å¼€å§‹é¢„è®­ç»ƒ...");
        trainer.train();
        
        // 8. æŸ¥çœ‹è®­ç»ƒå†å²
        System.out.println("è®­ç»ƒæŸå¤±å†å²:");
        var lossHistory = trainer.getLossHistory();
        System.out.println("åˆå§‹æŸå¤±: " + lossHistory.get(0));
        System.out.println("æœ€ç»ˆæŸå¤±: " + lossHistory.get(lossHistory.size() - 1));
    }
}
```

### è®­ç»ƒè¾“å‡ºç¤ºä¾‹

```
============================================================
å¼€å§‹Bananaå¤šæ¨¡æ€é¢„è®­ç»ƒ
============================================================
æ¨¡å‹é…ç½®: Banana BananaConfig
æ€»å‚æ•°é‡: 60823296 (60.82M)
è®­ç»ƒæ ·æœ¬æ•°: 1000
æ‰¹æ¬¡æ•°é‡: 250
æœ€å¤§è½®æ¬¡: 10
åˆå§‹å­¦ä¹ ç‡: 0.001
å›¾åƒå¤§å°: 256x256
============================================================
åˆæˆæ•°æ®ç”Ÿæˆå®Œæˆ,å…± 1000 ä¸ªæ ·æœ¬
æ‰¹æ¬¡å‡†å¤‡å®Œæˆ,å…± 250 ä¸ªæ‰¹æ¬¡

Epoch 1/10 | Step 10 | Loss: 0.8234 | LR: 0.001000
Epoch 1/10 | Step 20 | Loss: 0.7156 | LR: 0.001000
Epoch 1/10 | Step 30 | Loss: 0.6543 | LR: 0.001000
...
æ£€æŸ¥ç‚¹å·²ä¿å­˜: ./checkpoints/banana_pretrain/checkpoint_epoch0_step100.model
...
Epoch 1 å®Œæˆ | å¹³å‡æŸå¤±: 0.5234 | è€—æ—¶: 45632 ms
...
è®­ç»ƒå®Œæˆ!
```

---

## ğŸ¨ å¾®è°ƒæµç¨‹

### ä¸é¢„è®­ç»ƒçš„åŒºåˆ«

| ç‰¹æ€§ | é¢„è®­ç»ƒ | å¾®è°ƒ |
|------|--------|------|
| **å­¦ä¹ ç‡** | è¾ƒå¤§ (1e-3) | è¾ƒå° (1e-4) |
| **æ•°æ®é‡** | å¤§è§„æ¨¡é€šç”¨æ•°æ® | å°è§„æ¨¡ä»»åŠ¡æ•°æ® |
| **è®­ç»ƒè½®æ¬¡** | è¾ƒå¤š (10-100) | è¾ƒå°‘ (3-5) |
| **éªŒè¯é›†** | å¯é€‰ | å¿…éœ€ |
| **æ—©åœç­–ç•¥** | ä¸ä½¿ç”¨ | ä½¿ç”¨ (patience) |
| **ç›®æ ‡** | é€šç”¨è¡¨ç¤ºå­¦ä¹  | ä»»åŠ¡ç‰¹å®šä¼˜åŒ– |

### å®Œæ•´ä»£ç ç¤ºä¾‹

```java
package io.leavesfly.tinyai.banana.training;

import io.leavesfly.tinyai.banana.config.BananaConfig;
import io.leavesfly.tinyai.banana.model.BananaModel;
import io.leavesfly.tinyai.banana.training.dataset.BananaDataset;

import java.io.File;

public class FinetuneExample {
    
    public static void main(String[] args) throws Exception {
        // 1. åŠ è½½é¢„è®­ç»ƒæ¨¡å‹
        BananaModel model = BananaModel.create("banana_tiny", "tiny");
        
        // å¯é€‰ï¼šåŠ è½½é¢„è®­ç»ƒæƒé‡
        // File pretrainedModel = new File("checkpoints/banana_pretrain/checkpoint_epoch9_step2500.model");
        // if (pretrainedModel.exists()) {
        //     model.load(pretrainedModel);
        //     System.out.println("å·²åŠ è½½é¢„è®­ç»ƒæƒé‡");
        // }
        
        // 2. å‡†å¤‡å¾®è°ƒæ•°æ®é›†
        BananaConfig config = model.getConfig();
        
        // è®­ç»ƒé›†
        BananaDataset trainDataset = new BananaDataset(
            32, 
            config.getImageSize(), 
            4
        );
        trainDataset.loadSyntheticData(200);  // 80% æ•°æ®ç”¨äºè®­ç»ƒ
        
        // éªŒè¯é›†
        BananaDataset valDataset = new BananaDataset(
            32, 
            config.getImageSize(), 
            4
        );
        valDataset.loadSyntheticData(50);     // 20% æ•°æ®ç”¨äºéªŒè¯
        
        // 3. åˆ›å»ºå¾®è°ƒå™¨
        FinetuneTrainer trainer = new FinetuneTrainer(
            model, 
            trainDataset, 
            valDataset
        );
        
        // 4. é…ç½®å¾®è°ƒå‚æ•°
        trainer.configure(
            5,        // maxEpochs - å¾®è°ƒè½®æ¬¡ï¼ˆè¾ƒå°‘ï¼‰
            1e-4f,    // learningRate - å­¦ä¹ ç‡ï¼ˆæ¯”é¢„è®­ç»ƒå°10å€ï¼‰
            3         // patience - æ—©åœè€å¿ƒå€¼
        );
        
        // 5. é…ç½®æ£€æŸ¥ç‚¹ä¿å­˜
        trainer.setCheckpoint("./checkpoints/banana_finetune");
        
        // 6. å¼€å§‹å¾®è°ƒ
        System.out.println("å¼€å§‹å¾®è°ƒ...");
        trainer.train();
        
        // 7. æŸ¥çœ‹å¾®è°ƒç»“æœ
        System.out.println("\nå¾®è°ƒå®Œæˆ!");
        System.out.println("æœ€ä½³éªŒè¯æŸå¤±: " + trainer.getBestValLoss());
        System.out.println("æœ€ä½³æ¨¡å‹ä¿å­˜è·¯å¾„: ./checkpoints/banana_finetune/best_model.model");
    }
}
```

### æ—©åœæœºåˆ¶

å¾®è°ƒè®­ç»ƒå™¨ä½¿ç”¨æ—©åœç­–ç•¥é˜²æ­¢è¿‡æ‹Ÿåˆï¼š

```java
// æ—©åœé…ç½®
int patience = 3;  // å®¹å¿3ä¸ªepochéªŒè¯æŸå¤±ä¸ä¸‹é™

// è®­ç»ƒè¿‡ç¨‹
for (int epoch = 0; epoch < maxEpochs; epoch++) {
    trainOneEpoch();
    
    float valLoss = evaluate();
    
    if (valLoss < bestValLoss) {
        bestValLoss = valLoss;
        stepsWithoutImprovement = 0;
        saveBestModel();  // ä¿å­˜æœ€ä½³æ¨¡å‹
    } else {
        stepsWithoutImprovement++;
        if (stepsWithoutImprovement >= patience) {
            System.out.println("è§¦å‘æ—©åœ,å¾®è°ƒç»“æŸ");
            break;
        }
    }
}
```

### å¾®è°ƒè¾“å‡ºç¤ºä¾‹

```
============================================================
å¼€å§‹Bananaå¤šæ¨¡æ€å¾®è°ƒ
============================================================
æ¨¡å‹é…ç½®: Banana BananaConfig
æ€»å‚æ•°é‡: 60823296 (60.82M)
è®­ç»ƒæ ·æœ¬æ•°: 200
éªŒè¯æ ·æœ¬æ•°: 50
æœ€å¤§è½®æ¬¡: 5
å¾®è°ƒå­¦ä¹ ç‡: 0.0001
æ—©åœè€å¿ƒå€¼: 3
============================================================

Epoch 1/5 | Step 10 | Train Loss: 0.4523
Epoch 1/5 | Step 20 | Train Loss: 0.4234
...
Epoch 1 è®­ç»ƒå®Œæˆ | å¹³å‡æŸå¤±: 0.4012 | è€—æ—¶: 8234 ms
Epoch 1 éªŒè¯æŸå¤±: 0.3854 | æœ€ä½³éªŒè¯æŸå¤±: 0.3854
æœ€ä½³æ¨¡å‹å·²ä¿å­˜: ./checkpoints/banana_finetune/best_model.model

Epoch 2/5 | Step 30 | Train Loss: 0.3712
...
Epoch 2 éªŒè¯æŸå¤±: 0.3623 | æœ€ä½³éªŒè¯æŸå¤±: 0.3623
æœ€ä½³æ¨¡å‹å·²ä¿å­˜: ./checkpoints/banana_finetune/best_model.model

Epoch 3/5 | Step 50 | Train Loss: 0.3456
...
Epoch 3 éªŒè¯æŸå¤±: 0.3701 | æœ€ä½³éªŒè¯æŸå¤±: 0.3623
æœªæ”¹è¿›è½®æ•°: 1/3

...
Epoch 5 éªŒè¯æŸå¤±: 0.3899 | æœ€ä½³éªŒè¯æŸå¤±: 0.3623
æœªæ”¹è¿›è½®æ•°: 3/3
è§¦å‘æ—©åœ,å¾®è°ƒç»“æŸ

å¾®è°ƒå®Œæˆ!
æœ€ä½³éªŒè¯æŸå¤±: 0.3623
```

---

## ğŸ”§ è®­ç»ƒæŠ€å·§

### 1. å­¦ä¹ ç‡è°ƒåº¦

PretrainTrainerå®ç°äº†**é¢„çƒ­+ä½™å¼¦é€€ç«**ç­–ç•¥ï¼š

```java
/**
 * å­¦ä¹ ç‡è°ƒåº¦ç­–ç•¥
 */
private void updateLearningRate() {
    if (currentStep < warmupSteps) {
        // çº¿æ€§é¢„çƒ­é˜¶æ®µ
        currentLearningRate = initialLearningRate * ((float) currentStep / warmupSteps);
    } else {
        // ä½™å¼¦é€€ç«é˜¶æ®µ
        int totalSteps = maxEpochs * dataset.getBatchCount();
        int decaySteps = totalSteps - warmupSteps;
        int currentDecayStep = currentStep - warmupSteps;
        
        double cosineDecay = 0.5 * (1 + Math.cos(Math.PI * currentDecayStep / decaySteps));
        currentLearningRate = initialLearningRate * (float) cosineDecay;
    }
    
    optimizer.setLearningRate(currentLearningRate);
}
```

### 2. æ¢¯åº¦è£å‰ª

é˜²æ­¢æ¢¯åº¦çˆ†ç‚¸ï¼š

```java
/**
 * æ¢¯åº¦è£å‰ªç­–ç•¥
 */
private void clipGradients() {
    // è®¡ç®—L2èŒƒæ•°
    double totalNorm = 0.0;
    for (var param : model.getAllParams().values()) {
        if (param.getGrad() != null) {
            NdArray grad = param.getGrad();
            float[] gradData = ((NdArrayCpu) grad).buffer;
            for (float g : gradData) {
                totalNorm += g * g;
            }
        }
    }
    totalNorm = Math.sqrt(totalNorm);
    
    // è£å‰ªæ¢¯åº¦
    if (totalNorm > maxGradNorm) {
        float clipCoef = maxGradNorm / (float) totalNorm;
        for (var param : model.getAllParams().values()) {
            if (param.getGrad() != null) {
                // ç¼©æ”¾æ¢¯åº¦
                scaleGradient(param.getGrad(), clipCoef);
            }
        }
    }
}
```

### 3. æ‰¹æ¬¡å¤§å°é€‰æ‹©

| æ¨¡å‹è§„æ¨¡ | æ¨èæ‰¹æ¬¡å¤§å° | è¯´æ˜ |
|---------|------------|------|
| Tiny (60M) | 4-8 | æ•™å­¦æ¼”ç¤º |
| Small (167M) | 8-16 | å®éªŒç ”ç©¶ |
| Base (386M) | 16-32 | æ ‡å‡†è®­ç»ƒ |

**æ³¨æ„**: æ‰¹æ¬¡å¤§å°å—GPUæ˜¾å­˜é™åˆ¶ï¼Œéœ€æ ¹æ®å®é™…æƒ…å†µè°ƒæ•´ã€‚

### 4. è®­ç»ƒç›‘æ§

```java
// åœ¨è®­ç»ƒå¾ªç¯ä¸­è®°å½•æŸå¤±
lossHistory.add(stepLoss);

// å®šæœŸæ‰“å°ç»Ÿè®¡ä¿¡æ¯
if (currentStep % logInterval == 0) {
    double avgLoss = lossHistory.stream()
        .skip(Math.max(0, lossHistory.size() - logInterval))
        .mapToDouble(Float::doubleValue)
        .average()
        .orElse(0.0);
    
    System.out.printf("Epoch %d/%d | Step %d | Loss: %.4f | LR: %.6f%n",
        currentEpoch + 1, maxEpochs, currentStep, avgLoss, currentLearningRate);
}
```

---

## ğŸ“Š å®Œæ•´è®­ç»ƒæµç¨‹ç¤ºä¾‹

### ä½¿ç”¨TrainDemoè¿è¡Œ

```bash
# ç¼–è¯‘é¡¹ç›®
cd /Users/yefei.yf/Qoder/TinyAI/tinyai-model/tinyai-model-banana
mvn clean compile

# è¿è¡Œå®Œæ•´è®­ç»ƒæµç¨‹ï¼ˆé¢„è®­ç»ƒ + å¾®è°ƒï¼‰
mvn exec:java -Dexec.mainClass="io.leavesfly.tinyai.banana.training.demo.TrainDemo"

# åªè¿è¡Œé¢„è®­ç»ƒ
mvn exec:java -Dexec.mainClass="io.leavesfly.tinyai.banana.training.demo.TrainDemo" \
    -Dexec.args="pretrain"

# åªè¿è¡Œå¾®è°ƒ
mvn exec:java -Dexec.mainClass="io.leavesfly.tinyai.banana.training.demo.TrainDemo" \
    -Dexec.args="finetune"
```

### TrainDemoåŠŸèƒ½è¯´æ˜

`TrainDemo`æä¾›ä¸‰ç§è¿è¡Œæ¨¡å¼ï¼š

1. **é¢„è®­ç»ƒæ¼”ç¤º** (`pretrain`)
   - åˆ›å»ºTinyæ¨¡å‹
   - ç”Ÿæˆ100ä¸ªåˆæˆæ ·æœ¬
   - è®­ç»ƒ2ä¸ªepochï¼ˆå¿«é€Ÿæ¼”ç¤ºï¼‰
   - ä¿å­˜æ£€æŸ¥ç‚¹

2. **å¾®è°ƒæ¼”ç¤º** (`finetune`)
   - åˆ›å»º/åŠ è½½æ¨¡å‹
   - å‡†å¤‡è®­ç»ƒé›†(80)å’ŒéªŒè¯é›†(20)
   - ä½¿ç”¨æ—©åœç­–ç•¥è®­ç»ƒ
   - ä¿å­˜æœ€ä½³æ¨¡å‹

3. **å®Œæ•´æµç¨‹** (`all` æˆ–æ— å‚æ•°)
   - ä¾æ¬¡æ‰§è¡Œé¢„è®­ç»ƒå’Œå¾®è°ƒ
   - å±•ç¤ºå®Œæ•´çš„è®­ç»ƒâ†’å¾®è°ƒâ†’æ¨ç†æµç¨‹
   - è¾“å‡ºè®­ç»ƒæ€»ç»“

---

## ğŸ¯ æœ€ä½³å®è·µ

### 1. æ•°æ®å‡†å¤‡
- âœ… **æ•°æ®è´¨é‡ä¼˜å…ˆ**: é«˜è´¨é‡çš„æ–‡æœ¬-å›¾åƒå¯¹æ¯”å¤§é‡ä½è´¨é‡æ•°æ®æ›´é‡è¦
- âœ… **æ•°æ®å¤šæ ·æ€§**: ç¡®ä¿æ•°æ®è¦†ç›–ä¸åŒé£æ ¼ã€ä¸»é¢˜å’Œåœºæ™¯
- âœ… **æ•°æ®å¹³è¡¡**: é¿å…æŸäº›ç±»åˆ«æˆ–é£æ ¼æ•°æ®è¿‡å¤š
- âŒ **é¿å…æ•°æ®æ³„éœ²**: è®­ç»ƒé›†å’ŒéªŒè¯é›†ä¸¥æ ¼åˆ†ç¦»

### 2. è®­ç»ƒç­–ç•¥
- âœ… **å…ˆå¤§åå°**: å…ˆç”¨å¤§å­¦ä¹ ç‡é¢„è®­ç»ƒï¼Œå†ç”¨å°å­¦ä¹ ç‡å¾®è°ƒ
- âœ… **æ¸è¿›å¼è®­ç»ƒ**: ä»å°æ¨¡å‹å¼€å§‹éªŒè¯æµç¨‹ï¼Œå†æ‰©å±•åˆ°å¤§æ¨¡å‹
- âœ… **å®šæœŸä¿å­˜**: è®¾ç½®åˆç†çš„æ£€æŸ¥ç‚¹é—´éš”ï¼Œé˜²æ­¢è®­ç»ƒä¸­æ–­
- âŒ **é¿å…è¿‡æ‹Ÿåˆ**: ä½¿ç”¨éªŒè¯é›†ç›‘æ§ï¼ŒåŠæ—¶è§¦å‘æ—©åœ

### 3. è¶…å‚æ•°è°ƒä¼˜
- âœ… **å­¦ä¹ ç‡**: æœ€å…³é”®çš„è¶…å‚æ•°ï¼Œå»ºè®®ä»1e-4å¼€å§‹å°è¯•
- âœ… **æ‰¹æ¬¡å¤§å°**: åœ¨æ˜¾å­˜å…è®¸èŒƒå›´å†…å°½é‡å¤§
- âœ… **æ¢¯åº¦è£å‰ª**: è®¾ç½®ä¸º1.0é€šå¸¸æœ‰æ•ˆ
- âœ… **é¢„çƒ­æ­¥æ•°**: å¤§æ¨¡å‹å»ºè®®500-1000æ­¥

### 4. è°ƒè¯•æŠ€å·§
- âœ… **å…ˆè¿‡æ‹Ÿåˆå°æ•°æ®**: ç”¨10-20ä¸ªæ ·æœ¬æµ‹è¯•æ¨¡å‹èƒ½å¦è¿‡æ‹Ÿåˆ
- âœ… **ç›‘æ§æ¢¯åº¦èŒƒæ•°**: ç¡®ä¿æ¢¯åº¦ä¸ä¼šçˆ†ç‚¸æˆ–æ¶ˆå¤±
- âœ… **å¯è§†åŒ–æŸå¤±æ›²çº¿**: è§‚å¯Ÿè®­ç»ƒæ˜¯å¦ç¨³å®šæ”¶æ•›
- âœ… **å®šæœŸéªŒè¯**: åœ¨éªŒè¯é›†ä¸Šè¯„ä¼°æ³›åŒ–èƒ½åŠ›

---

## ğŸ” å¸¸è§é—®é¢˜

### Q1: è®­ç»ƒæŸå¤±ä¸ä¸‹é™æ€ä¹ˆåŠï¼Ÿ

**å¯èƒ½åŸå› **:
1. å­¦ä¹ ç‡è¿‡å¤§æˆ–è¿‡å°
2. æ•°æ®é¢„å¤„ç†æœ‰é—®é¢˜
3. æ¨¡å‹é…ç½®é”™è¯¯
4. æ¢¯åº¦è®¡ç®—æœ‰è¯¯

**è§£å†³æ–¹æ¡ˆ**:
```java
// 1. é™ä½å­¦ä¹ ç‡
trainer.configure(10, 1e-5f, 0, 1.0f);  // ä»1e-4é™åˆ°1e-5

// 2. æ£€æŸ¥æ•°æ®
dataset.prepare(true);
BananaDataset.Batch batch = dataset.getNextBatch();
System.out.println("Text shape: " + batch.getTextInput().getShape());
System.out.println("Image shape: " + batch.getImageInput().getShape());

// 3. éªŒè¯å°æ•°æ®é›†
dataset.loadSyntheticData(10);  // åªç”¨10ä¸ªæ ·æœ¬æµ‹è¯•
```

### Q2: æ˜¾å­˜ä¸è¶³ï¼ˆOOMï¼‰æ€ä¹ˆåŠï¼Ÿ

**è§£å†³æ–¹æ¡ˆ**:
```java
// 1. å‡å°æ‰¹æ¬¡å¤§å°
BananaDataset dataset = new BananaDataset(32, 256, 2);  // batchSizeä»4é™åˆ°2

// 2. ä½¿ç”¨æ›´å°çš„æ¨¡å‹
BananaModel model = BananaModel.create("banana_tiny", "tiny");  // ä½¿ç”¨Tinyè€ŒéBase

// 3. å‡å°å›¾åƒå°ºå¯¸
BananaConfig config = BananaConfig.createTinyConfig();
config.setImageSize(128);  // ä»256é™åˆ°128
```

### Q3: å¦‚ä½•åŠ è½½é¢„è®­ç»ƒæ¨¡å‹ç»§ç»­è®­ç»ƒï¼Ÿ

```java
// 1. ä¿å­˜æ£€æŸ¥ç‚¹
trainer.setCheckpoint("./checkpoints/banana_pretrain", 100);

// 2. åŠ è½½æ£€æŸ¥ç‚¹ç»§ç»­è®­ç»ƒ
File checkpoint = new File("./checkpoints/banana_pretrain/checkpoint_epoch5_step1000.model");
if (checkpoint.exists()) {
    model.load(checkpoint);
    System.out.println("å·²åŠ è½½æ£€æŸ¥ç‚¹: " + checkpoint.getName());
}

// 3. ç»§ç»­è®­ç»ƒ
trainer.train();  // ä»åŠ è½½çš„æƒé‡ç»§ç»­
```

### Q4: å¦‚ä½•è¯„ä¼°æ¨¡å‹æ•ˆæœï¼Ÿ

```java
// 1. æŸ¥çœ‹è®­ç»ƒæŸå¤±æ›²çº¿
var lossHistory = trainer.getLossHistory();
System.out.println("æŸå¤±å˜åŒ–: " + 
    lossHistory.get(0) + " -> " + 
    lossHistory.get(lossHistory.size() - 1));

// 2. åœ¨éªŒè¯é›†ä¸Šè¯„ä¼°
FinetuneTrainer finetuner = new FinetuneTrainer(model, trainDataset, valDataset);
finetuner.train();
System.out.println("æœ€ä½³éªŒè¯æŸå¤±: " + finetuner.getBestValLoss());

// 3. ä½¿ç”¨æ¨¡å‹è¿›è¡Œæ¨ç†æµ‹è¯•
Variable textInput = new Variable(NdArray.of(Shape.of(1, 10)));
Variable imageInput = new Variable(NdArray.of(Shape.of(1, 3, 256, 256)));
Variable output = model.getBananaBlock().forwardMultiModal(
    model.encodeText(textInput),
    model.encodeImage(imageInput),
    TaskType.TEXT_TO_IMAGE
);
System.out.println("æ¨ç†è¾“å‡ºshape: " + output.getValue().getShape());
```

---

## ğŸ“š å‚è€ƒèµ„æ–™

### TinyAIæ¡†æ¶æ–‡æ¡£
- [æŠ€æœ¯æ¶æ„æ–‡æ¡£](./æŠ€æœ¯æ¶æ„æ–‡æ¡£.md) - Bananaæ¨¡å‹çš„æ¶æ„è®¾è®¡
- [APIå‚è€ƒæ–‡æ¡£](./APIå‚è€ƒæ–‡æ¡£.md) - å®Œæ•´çš„APIä½¿ç”¨æŒ‡å—

### ç›¸å…³è®ºæ–‡
- Vision Transformer (ViT): "An Image is Worth 16x16 Words"
- CLIP: "Learning Transferable Visual Models From Natural Language Supervision"
- Flamingo: "Tackling Multiple Tasks with a Single Visual Language Model"

### å…¶ä»–æ¨¡å‹å‚è€ƒ
- [GPT-1è®­ç»ƒæ–‡æ¡£](../../tinyai-model-gpt/src/main/java/io/leavesfly/tinyai/gpt1/TRAINING_README.md)
- [MiniMindè®­ç»ƒæ–‡æ¡£](../../tinyai-model-minimind/doc/)

---

## ğŸ“ æ›´æ–°æ—¥å¿—

- **2025-12-21**: åˆå§‹ç‰ˆæœ¬ï¼ŒåŒ…å«å®Œæ•´çš„é¢„è®­ç»ƒå’Œå¾®è°ƒæŒ‡å—
- æ·»åŠ PretrainTrainerå’ŒFinetuneTrainerçš„è¯¦ç»†ä½¿ç”¨è¯´æ˜
- æä¾›å®Œæ•´çš„ä»£ç ç¤ºä¾‹å’Œæœ€ä½³å®è·µ
- è¡¥å……å¸¸è§é—®é¢˜å’Œè°ƒè¯•æŠ€å·§

---

**æ–‡æ¡£ç‰ˆæœ¬**: v1.0  
**æœ€åæ›´æ–°**: 2025-12-21  
**ç»´æŠ¤è€…**: TinyAI Team
